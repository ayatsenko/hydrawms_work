<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.thymeleaf.org ">
<body>
<span th:fragment="sea_ships_tasks_modal_body" th:remove="tag">
    <div class="modal fade was-validated" id="sea_ships_tasks_modal" data-toggle="validator" tabindex="-1" role="dialog" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="hidden">
                <input type="hidden" id="mode">
            </div>

            <div class="modal-content" id="sea_ships_tasks_modal_detail">
                <div class="modal-header">
                    <h5 class="modal-title" th:text="#{sea_ships.tasks.caption}"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body m-1">
                    <form id="sea_ships_tasks_modal_form" name="sea_ships_tasks_modal_form" class="was-validated" novalidate>
                    <input type="hidden" id="sea_ships_tasks_modal_mode">

                    <div class="form-row">
                        <div class="col-12 col-md-3 mb-1" id="sea_ships_tasks_modal_clm_id_row">
                            <label for="sea_ships_tasks_modal_clm_id" class="form-label" th:text="#{sea_ships.main.clm_id}"></label>
                            <input type="number" class="form-control" id="sea_ships_tasks_modal_clm_id" name="sea_ships_tasks_modal_clm_id" readonly>
                            <div class="valid-feedback" th:text="#{general.field_fill}"> Looks good! </div>
                            <div class="invalid-feedback" th:text="#{general.filed_unfilled}"> Bad! </div>
                        </div>

                        <div class="col-12 col-md-3 mb-1" id="sea_ships_tasks_modal_clm_num_row">
                            <label for="sea_ships_tasks_modal_clm_num" class="form-label" th:text="'1. '+ #{sea_ships.main.clm_num}"></label>
                            <input type="text" maxlength="16" class="form-control" id="sea_ships_tasks_modal_clm_num" name="sea_ships_tasks_modal_clm_num" readonly>
                            <div class="valid-feedback" th:text="#{general.field_fill}"> Looks good! </div>
                            <div class="invalid-feedback" th:text="#{general.filed_unfilled}"> Bad! </div>
                        </div>

                        <div class="col-12 col-md-6 mb-1" id="cnt_name_row">
                            <label for="sea_ships_tasks_modal_cnt_name" class="form-label" th:text="'2. '+ #{sea_ships.main.cnt_name}"></label>
                            <input type="text" class="form-control" id="sea_ships_tasks_modal_cnt_name" name="sea_ships_tasks_modal_cnt_name" readonly>
                            <div class="valid-feedback" th:text="#{general.field_fill}"> Looks good! </div>
                            <div class="invalid-feedback" th:text="#{general.filed_unfilled}"> Bad! </div>
                        </div>
                    </div> <!-- Row 1 -->

                    <div class="form-row">
                        <div class="col-12 col-md-3 mb-1" id="clmtl_id_row">
                            <label for="clmtl_id" class="form-label" th:text="#{sea_ships.tasks.clmtl_id}"></label>
                            <input type="number" class="form-control" id="clmtl_id" name="clmtl_id" readonly>
                            <div class="valid-feedback" th:text="#{general.field_fill}"> Looks good! </div>
                            <div class="invalid-feedback" th:text="#{general.filed_unfilled}"> Bad! </div>
                        </div>

                        <div class="col-12 col-md-6 mb-1">
                            <label for="clm_task_id" class="mr-2" th:text="'3. '+#{sea_ships.tasks.clm_task_sname}">Tasks: </label>
                            <select type="text" id="clm_task_id" name="clm_task_id" class="form-control p-1">
                            </select>
                            <div class="valid-feedback" th:text="#{general.field_fill}"> Looks good! </div>
                            <div class="invalid-feedback" th:text="#{general.filed_unfilled}"> Bad! </div>
                        </div>
                    </div> <!-- Row 2 -->

                    <div class="form-row">
                        <div class="col-12 col-md-6 mb-1" id="start_user_id_row">
                            <label for="start_user_id" class="mr-2" th:text="'4. '+#{sea_ships.tasks.start_user_name}">Start User: </label>
                            <!--suppress ThymeleafVariablesResolveInspection -->
                            <select type="text" id="start_user_id" name="start_user_id" class="form-control p-1" th:value="${start_user_id}">
                            </select>
                            <div class="valid-feedback" th:text="#{general.field_fill}"> Looks good! </div>
                            <div class="invalid-feedback" th:text="#{general.filed_unfilled}"> Bad! </div>
                        </div>

                        <div class="col-12 col-md-3 mb-1" id="deadline_date_row">
                            <label for="deadline_date" class="form-label" th:text="'5. '+ #{sea_ships.tasks.deadline_date}"></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="deadline_date" name="deadline_date">
                                <button type="button" id="deadline_date_x" name="deadline_date_x" class="btn btn-outline-primary"><i class="fas fa-times"></i></button>
                                <div class="valid-feedback" th:text="#{general.field_fill}"> Looks good! </div>
                                <div class="invalid-feedback" th:text="#{general.filed_unfilled}"> Bad! </div>
                            </div>
                        </div>

                        <div class="col-12 col-md-3 mb-1" id="sea_ships_tasks_modal_start_date_row">
                            <label for="sea_ships_tasks_modal_start_date" class="form-label" th:text="'6. '+ #{sea_ships.tasks.start_date}"></label>
                            <input type="text" class="form-control" id="sea_ships_tasks_modal_start_date" name="sea_ships_tasks_modal_start_date" readonly>
                            <div class="valid-feedback" th:text="#{general.field_fill}"> Looks good! </div>
                            <div class="invalid-feedback" th:text="#{general.filed_unfilled}"> Bad! </div>
                        </div>
                    </div> <!-- Row 3 -->

                    <div class="form-row">
                        <div class="col-12 col-md-6 mb-1" id="end_user_id_row">
                            <label for="end_user_id" th:text="'7. '+#{sea_ships.tasks.end_user_name}">End User: </label>
                            <select type="text" id="end_user_id" name="end_user_id" class="form-control p-1">
                            </select>
                            <div class="valid-feedback" th:text="#{general.field_fill}"> Looks good! </div>
                            <div class="invalid-feedback" th:text="#{general.filed_unfilled}"> Bad! </div>
                        </div>

                        <div class="col-12 col-md-3 mb-1" id="sea_ships_tasks_modal_end_date_row">
                            <label for="sea_ships_tasks_modal_end_date" class="form-label" th:text="'8. '+ #{sea_ships.tasks.end_date}"></label>
                            <input type="text" class="form-control" id="sea_ships_tasks_modal_end_date" name="sea_ships_tasks_modal_end_date" readonly>
                            <div class="valid-feedback" th:text="#{general.field_fill}"> Looks good! </div>
                            <div class="invalid-feedback" th:text="#{general.filed_unfilled}"> Bad! </div>
                        </div>
                    </div> <!-- Row 4 -->

                    <div class="form-row">
                        <div class="col-12 mb-2">
                            <label for="clmtl_note" th:text="'9. '+#{sea_ships.tasks.clmtl_note}"></label>
                            <textarea class="form-control" rows="5" maxlength="512" style="resize:none;" id="clmtl_note" name="clmtl_note">
                            </textarea>
                            <div class="valid-feedback" th:text="#{general.field_fill}"> Looks good! </div>
                            <div class="invalid-feedback" th:text="#{general.filed_unfilled}"> Bad! </div>
                        </div>
                    </div>  <!-- Row 5 -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" id="sea_ships_tasks_modal_closebtn" class="btn btn-outline-dark mr-1" data-dismiss="modal" th:text="#{general.back}"></button>
                    <button type="button" id="sea_ships_tasks_modal_addbtn" class="btn btn-outline-primary" th:text="#{general.addbtn}" hidden></button>
                    <button type="button" id="sea_ships_tasks_modal_editbtn" class="btn btn-outline-primary" th:text="#{general.editbtn}" hidden></button>
                    <button type="button" id="sea_ships_tasks_modal_delbtn" class="btn btn-outline-primary" th:text="#{general.delbtn}" hidden></button>
                </div>
            </div>
        </div>
    </div>
</span>

<script th:fragment="cardscript" th:inline="javascript">

// Clear Fields
    function clear_sea_ships_tasks_modal_detail() {
        $("#sea_ships_tasks_modal_detail input[type=text]").val('');
        $("#sea_ships_tasks_modal_detail input[type=number]").val('');
        $("#sea_ships_tasks_modal_detail select").empty();
        $("#sea_ships_tasks_modal_detail textarea").val('');
    }

// Block And Required Fields
    function block_sea_ships_tasks_modal_detail(){
        $('#clm_task_id').attr('required', true);
        $('#start_user_id').attr('required', true);

        if($('#sea_ships_tasks_modal_mode').val() === "0"){
            $('#sea_ships_tasks_modal_clm_id_row').attr('hidden',true);
            $('#clmtl_id_row').attr('hidden',true);
            $('#clm_task_id').removeAttr('disabled');
            $('#start_user_id').removeAttr('disabled');
            $('#end_user_id').removeAttr('disabled');
            $('#clmtl_note').removeAttr('readonly');
            $('#deadline_date').removeAttr('disabled');
            $('#deadline_date_x').removeAttr('disabled').addClass('btn-outline-primary').removeClass('btn-outline-dark');
        }
        else if($('#sea_ships_tasks_modal_mode').val() === "1"){
            $('#sea_ships_tasks_modal_clm_id_row').attr('hidden',true);
            $('#clmtl_id_row').attr('hidden',true);
            $('#clm_task_id').removeAttr('disabled');
            $('#start_user_id').removeAttr('disabled');
            $('#end_user_id').removeAttr('disabled');
            $('#clmtl_note').removeAttr('readonly');
            $('#deadline_date').removeAttr('disabled');
            $('#deadline_date_x').removeAttr('disabled').addClass('btn-outline-primary').removeClass('btn-outline-dark');
        }
        else{
            $('#sea_ships_tasks_modal_clm_id_row').attr('hidden',true);
            $('#clmtl_id_row').attr('hidden',true);

            $('#clm_task_id').attr('disabled',true);
            $('#start_user_id').attr('disabled',true);
            $('#end_user_id').attr('disabled',true);
            $('#clmtl_note').attr('readonly',true);
            $('#deadline_date').attr('disabled',true);
            $('#deadline_date_x').attr('disabled',true).removeClass('btn-outline-primary').addClass('btn-outline-dark');
        }
    }
// Tasks List
    function tasksChange(vMode, vClmTaskID) {
        $('#clm_task_id').empty();
        return Promise.resolve($.ajax({
            url:/*[[@{'/sea_ships/get_clm_tasks_list'}]]*/ "/sea_ships/get_clm_tasks_list",
            type: "get",
            data: {
                "mode": vMode,
                "clm_id": $('#sea_ships_tasks_modal_clm_id').val(),
                "clm_task_id": vClmTaskID
            },
            success: function (clm_tasks_list) {
                for (var i = 0; i < clm_tasks_list.data.length; i++) {
                    if(i === 0) {
                        $("select[name='clm_task_id']").find('option').end().append("<option value=''></option>");
                    }
                    $("select[name='clm_task_id']").find('option').end().append(
                        "<option value='" + clm_tasks_list.data[i].clm_task_id
                        + "'>" + clm_tasks_list.data[i].clm_task_name + "</option>");
                }
                if(vClmTaskID !== ''){
                    $('#clm_task_id').val(vClmTaskID);
                }
            }
        }));
    }

// Start Users List
function startUsersChange(vMode, vStartUserID) {
    $('#start_user_id').empty();
    return Promise.resolve($.ajax({
        url:/*[[@{'/sea_ships/get_tasks_start_users_list'}]]*/ "/sea_ships/get_tasks_start_users_list",
        type: "get",
        data: {
            "mode": vMode,
            "start_user_id": vStartUserID
        },
        success: function (tasks_start_users_list) {
            for (var i = 0; i < tasks_start_users_list.data.length; i++) {
                $("select[name='start_user_id']").find('option').end().append(
                    "<option value='" + tasks_start_users_list.data[i].id
                    + "'>" + tasks_start_users_list.data[i].user_surname + "</option>");
            }
        }
    }));
}

// End Users List
function endUsersChange(vMode, vEndUserID) {
    $('#end_user_id').empty();
    return Promise.resolve($.ajax({
        url:/*[[@{'/sea_ships/get_tasks_end_users_list'}]]*/ "/sea_ships/get_tasks_end_users_list",
        type: "get",
        data: {
            "mode": vMode,
            "end_user_id": vEndUserID
        },
        success: function (tasks_end_users_list) {
            for (var i = 0; i < tasks_end_users_list.data.length; i++) {
                if(i === 0) {
                    $("select[name='end_user_id']").find('option').end().append("<option value=''></option>");
                }
                $("select[name='end_user_id']").find('option').end().append(
                    "<option value='" + tasks_end_users_list.data[i].id
                    + "'>" + tasks_end_users_list.data[i].user_surname + "</option>");
                if(vEndUserID !== ''){
                    $('#end_user_id').val(vEndUserID);
                }
            }
        }
    }));
}

// Dead Line Date
$("#deadline_date").daterangepicker({
    "singleDatePicker": true,
    "timePicker" : true,
    "timePicker24Hour" : true,
    "locale": {
        "format": "DD.MM.YYYY HH:mm",
        "separator": " - ",
        "applyLabel": /*[[#{datapicker.apply}]]*/ "Applay",
        "cancelLabel": /*[[#{datapicker.cancel}]]*/ "Cancel",
        "fromLabel": "From",
        "toLabel": "To",
        "customRangeLabel": "Custom",
        "weekLabel":  /*[[#{datapicker.week}]]*/ "W",
        "daysOfWeek": [
            /*[[#{weekdays.07_short}]]*/ "Su",
            /*[[#{weekdays.01_short}]]*/ "Mo",
            /*[[#{weekdays.02_short}]]*/ "Tu",
            /*[[#{weekdays.03_short}]]*/ "We",
            /*[[#{weekdays.04_short}]]*/ "Th",
            /*[[#{weekdays.05_short}]]*/ "Fr",
            /*[[#{weekdays.06_short}]]*/ "Sa"
        ],
        "monthNames": [
            /*[[#{month.01}]]*/ "January",
            /*[[#{month.02}]]*/ "February",
            /*[[#{month.03}]]*/ "March",
            /*[[#{month.04}]]*/ "April",
            /*[[#{month.05}]]*/ "May",
            /*[[#{month.06}]]*/ "June",
            /*[[#{month.07}]]*/ "July",
            /*[[#{month.08}]]*/ "August",
            /*[[#{month.09}]]*/ "September",
            /*[[#{month.10}]]*/ "October",
            /*[[#{month.11}]]*/ "November",
            /*[[#{month.12}]]*/ "December"
        ],
        "firstDay": 1
    }
});

// Load Function
    function fill_sea_ships_tasks_modal_detail(aMode){
        $('#sea_ships_tasks_modal_mode').val(aMode);
        clear_sea_ships_tasks_modal_detail();
        block_sea_ships_tasks_modal_detail();

        $('#sea_ships_tasks_modal_clm_id').val(vFSClaimsValue.rowdata.clm_id);
        $('#sea_ships_tasks_modal_clm_num').val(vFSClaimsValue.rowdata.clm_num);
        $('#sea_ships_tasks_modal_cnt_name').val(vFSClaimsValue.rowdata.cnt_name);

        if(aMode !== 0){
            $.ajax({
                url:/*[[@{'/sea_ships/get_tasks_detail'}]]*/ "sea_ships/get_tasks_detail",
                type: "get",
                data: {
                    "clmtl_id": vFSClaimsTasksValue.rowdata.clmtl_id,
                    "mode": aMode
                },
                success: function (sea_ships_tasks_modal_detail) {
                    $.when(
                        tasksChange(aMode,sea_ships_tasks_modal_detail.data[0].clm_task_id),
                        startUsersChange(aMode,sea_ships_tasks_modal_detail.data[0].start_user_id),
                        endUsersChange(aMode,sea_ships_tasks_modal_detail.data[0].end_user_id)
                    ).then(function () {
                        $('#clmtl_id').val(sea_ships_tasks_modal_detail.data[0].clmtl_id);
                        $('#deadline_date').val(sea_ships_tasks_modal_detail.data[0].deadline_date);
                        $('#sea_ships_tasks_modal_start_date').val(sea_ships_tasks_modal_detail.data[0].start_date);
                        $('#sea_ships_tasks_modal_end_date').val(sea_ships_tasks_modal_detail.data[0].end_date);
                        $('#clmtl_note').val(sea_ships_tasks_modal_detail.data[0].clmtl_note);

                        $('#sea_ships_tasks_modal').modal('show');
                    });
                }
            });
        }
        else{
            $.when(
                tasksChange(aMode,0),
                startUsersChange(aMode,0),
                endUsersChange(aMode,0)
            ).then(function () {
                $('#sea_ships_tasks_modal').modal('show');
            });
        }
    }

// Add button script
function addFullWorldTasks(){
    let MainRowID = vFSClaimsValue.rowdata.clm_id;
    let RowID = vFSClaimsTasksValue.rowdata.clmtl_id;
    $.ajax({
        url: /*[[ @{/sea_ships/add_tasks} ]]*/ "/sea_ships/add_tasks",
        type: 'POST',
        data: {
            "clm_id": MainRowID,
            "clm_task_id": $('#clm_task_id').val(),
            "start_user_id":  $('#start_user_id').val(),
            "end_user_id":  $('#end_user_id').val(),
            "clmtl_note":  $('#clmtl_note').val(),
            "deadline_date":  $('#deadline_date').val()
        },
        success: function (result) {
            $('#sea_ships_tasks_modal').modal('hide');
            vFSClaimsTasksValue.rowdata.clm_id = MainRowID;
            vFSClaimsTasksValue.rowdata.clmtl_id = RowID;
            $(vFSClaimsTasksValue.table).DataTable().ajax.reload(null, false);
        }
    });
}

// Edit button script
function editFullWorldTasks(){
    let MainRowID = vFSClaimsValue.rowdata.clm_id;
    let RowID = vFSClaimsTasksValue.rowdata.clmtl_id;
    $.ajax({
        url: /*[[ @{/sea_ships/edit_tasks} ]]*/ "/sea_ships/edit_tasks",
        type: 'POST',
        data: {
            "clmtl_id": RowID,
            "clm_task_id": $('#clm_task_id').val(),
            "start_user_id":  $('#start_user_id').val(),
            "end_user_id":  $('#end_user_id').val(),
            "clmtl_note":  $('#clmtl_note').val(),
            "deadline_date":  $('#deadline_date').val()
        },
        success: function (result) {
            $('#sea_ships_tasks_modal').modal('hide');
            vFSClaimsTasksValue.rowdata.clm_id = MainRowID;
            vFSClaimsTasksValue.rowdata.clmtl_id = RowID;
            $(vFSClaimsTasksValue.table).DataTable().ajax.reload(null, false);
        }
    });
}

// Del button script
function delFullWorldTasks(){
    let MainRowID = vFSClaimsValue.rowdata.clm_id;
    let RowID = vFSClaimsTasksValue.rowdata.clmtl_id;
    $.ajax({
        url: /*[[ @{/sea_ships/del_tasks} ]]*/ "/sea_ships/del_tasks",
        type: 'POST',
        data: {
            "clmtl_id": RowID
        },
        success: function (result) {
            $('#sea_ships_tasks_modal').modal('hide');
            vFSClaimsTasksValue.rowdata.clm_id = MainRowID;
            $(vFSClaimsTasksValue.table).DataTable().ajax.reload(null, false);
        }
    });
}

// Add button script
$('#sea_ships_tasks_modal_addbtn').click(function(){
    $('#sea_ships_tasks_modal_form').submit();
});
// Edit button script
$('#sea_ships_tasks_modal_editbtn').click(function(){
    $('#sea_ships_tasks_modal_form').submit();
});
// Del button script
$('#sea_ships_tasks_modal_delbtn').click(function(){
    $('#sea_ships_tasks_modal_form').submit();
});

//Validation Form
$('#sea_ships_tasks_modal_form').validate({
    rules: {
        // amount: {
        //     //money: true, // not a valid rule
        //     required: true
        // },
        // comment: {
        //     required: false
        // }
    },
    errorPlacement: function (error, element) {
        return true;
    },
    submitHandler: function (form) {
        if ($('#sea_ships_tasks_modal_mode').val() === '0') {
            addFullWorldTasks();
        } else if ($('#sea_ships_tasks_modal_mode').val() === '1') {
            editFullWorldTasks();
        } else if ($('#sea_ships_tasks_modal_mode').val() === '2') {
            delFullWorldTasks();
        }
        return false;
    }
});

// OnClick Function
$('#deadline_date_x').on('click', function() {
    $('#deadline_date').empty().val('');
});
</script>

</body>
</html>